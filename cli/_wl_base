#!/bin/bash

ENV_FILE="${HOME}/.wordland.env"

WL_DIR="${HOME}/.wordland"
SESSION_JSON="${WL_DIR}/session.json"
CURRENT_ROOM=${WL_DIR}/current_room

DEFAULT_API="http://127.0.0.1:9091/api"
WL_API_KEY="x-wordland-api-key"

function die {
  if [[ -z "${SCRIPT}" ]] ; then
    echo 1>&2 "${1}"
  else
    echo 1>&2 "${SCRIPT}: ${1}"
  fi
  exit 1
}

function error {
  NO_NEWLINE=""
  if [[ ${1} == "-n" ]] ; then
    NO_NEWLINE="-n"
    shift
  fi
  RED='\033[38;5;9m'
  NC='\033[0m' # No Color
  echo 1>&2 -e ${NO_NEWLINE} "\n${RED}${@}${NC}"
}

function error_stdout {
  RED='\033[38;5;9m'
  NC='\033[0m' # No Color
  echo -e -n "\n${RED}${@}${NC}"
}

function env_val {
  param="${1}"
  cat ${ENV_FILE} | grep "export ${param}=" | awk -F '=' '{print $2}'
}

function json_node {
  echo "${1}" | jq .${2}
}
function json_val {
  json_node "${1}" "${2}" | tr -d '" '
}
function session_val {
  if [[ -f ${SESSION_JSON} ]] ; then
    json_val "$(cat ${SESSION_JSON})" "${1}"
  fi
}
function session_player {
  session_val id
}
function session_apiToken {
  session_val apiToken
}
function session_name {
  session_val name
}
function session_email {
  session_val email
}

function current_room {
  if [[ -f ${CURRENT_ROOM} ]] ; then
    cat ${CURRENT_ROOM}
  fi
}

function lang {
  echo "${LANG}" | awk -F '_' '{print $1}'| tr '[:upper:]' '[:lower:]'
}

function lang_pack_msg {
  LANG_PACK="${1}"
  msg_key="${2}"
  echo "$(. ${LANG_PACK} && echo "${!msg_key}")"
}

function translate_message {
  LANG_PACK="${WL_DIR}/messages.$(lang).txt"
  if [[ -f ${LANG_PACK} ]] ; then
    message="$(lang_pack_msg ${LANG_PACK} ${@})"
    if [[ ! -z "${message}" ]] ; then
      echo "${message}"
      return
    fi
  fi
  LOCAL_LANG_PACK="${SCRIPT_DIR}/lang/messages.$(lang).txt"
  if [[ -f ${LOCAL_LANG_PACK} ]] ; then
    message="$(lang_pack_msg ${LOCAL_LANG_PACK} ${@})"
    if [[ ! -z "${message}" ]] ; then
      echo "${message}"
      return
    fi
  fi
  DEFAULT_LANG_PACK="${SCRIPT_DIR}/lang/messages.en.txt"
  if [[ -f ${DEFAULT_LANG_PACK} ]] ; then
    message="$(lang_pack_msg ${DEFAULT_LANG_PACK} ${@})"
    if [[ ! -z "${message}" ]] ; then
      echo "${message}"
      return
    fi
  fi

  echo "??? ${@}"
}

function translate_messages {
  for err in ${@} ; do
    translate_message "${err}"
  done
}

function wl_prompt {
  name="$(session_name)"
  if [[ -z "${name}" ]] ; then
    name="not-signed-on"
  fi
  room="$(current_room)"
  if [[ ! -z "${WL_VERBOSE_PROMPT}" && "${WL_VERBOSE_PROMPT}" == "Y" ]] ; then
    if [[ ! -z "${room}" ]] ; then
      room="/${room}"
    fi
    echo "${name}@$(echo "${WL_API}" | awk -F[/:] '{print $4}')${room}>>> "
  else
    if [[ ! -z "${room}" ]] ; then
    room="@${room}"
    fi
    echo "${name}${room}>>> "
  fi
}

function wl_exists {
  SESSION_TOKEN="${1}"
  URL="${2}"
  response=$(curl --silent --write-out "\n%{http_code}\n" --header "${SESSION_TOKEN}" ${URL})
  status_code=$(echo "${response}" | sed -n '$p')
  if [[ -z "${status_code}" || ${status_code} -ne 200 ]] ; then
    echo "false"
  else
    echo "true"
  fi
}

function wl_get {
  SESSION_TOKEN="${1}"
  URL="${2}"
  FAIL_ON_EMPTY_RESPONSE="${3:-N}"
  ERR_MESSAGE="${4:-error}"

  response=$(curl --silent --write-out "\n%{http_code}\n" --header "${SESSION_TOKEN}" ${URL})
  status_code=$(echo "${response}" | sed -n '$p')
  json=$(echo "${response}" | sed '$d')
  if [ -z "${status_code}" ] ; then
    die "${ERR_MESSAGE}: ${json}"
  fi
  if [[ ${status_code} -eq 200 && ( ! -z "${json}" || ${FAIL_ON_EMPTY_RESPONSE} != "Y"  ) ]] ; then
    echo "${json}"
  else
    die "${ERR_MESSAGE}: ${status_code} / ${json}"
  fi
}

function wl_post {
  SESSION_TOKEN="${1}"
  URL="${2}"
  DATA="${3}"
  OUTFILE="${4:-/dev/null}"
  ERR_MESSAGE="${5:-error}"

  response=$(echo "${DATA}" | curl --silent --write-out "\n%{http_code}\n" --header "Content-Type: application/json" --header "${SESSION_TOKEN}" -X POST -d @- ${URL})
  status_code=$(echo "${response}" | sed -n '$p')
  json=$(echo "${response}" | sed '$d' | tee ${OUTFILE})
  if [ -z "${status_code}" ] ; then
    die "${ERR_MESSAGE}: ${json}"
  fi
  if [[ ${status_code} -eq 200 && ! -z "${json}" ]] ; then
    echo "${json}"
  elif [[ ${status_code} -eq 422 ]] ; then
    error_stdout "$(translate_messages $(echo "${json}" | jq .[].messageTemplate | tr -d '"' | tr '.' '_'))"
  else
    die "${ERR_MESSAGE}: ${status_code} / ${json}"
  fi
}

if [ -f ${ENV_FILE} ] ; then
  . ${ENV_FILE}
fi

if [ -z "${WL_API}" ] ; then
  #die "no WL_API defined"
  #echo "No WL_API defined, using default ${DEFAULT_API}"
  WL_API="${DEFAULT_API}"
fi

# check API availability
response=$(curl --silent --write-out "\n%{http_code}\n" ${WL_API}/auth/ping)
status_code=$(echo "${response}" | sed -n '$p')
if [[ -z "${status_code}" || ${status_code} -ne 200 ]] ; then
  die "$(translate_message err_api_unavailable): ${WL_API}"
fi
